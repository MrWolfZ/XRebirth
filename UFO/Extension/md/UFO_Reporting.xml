<?xml version="1.0" encoding="utf-8"?>
<!-- 
	This file is part of the X Rebirth UFO mod.
	
	Author: MadJoker
  
  Last Change:
	Version: V0.4.3 Beta
	Date: 25th Dec 2013
  
  X Rebirth version: 1.21
-->
<mdscript name="UFO_Reporting" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../../../Resources/md.xsd">
  <cues>
    <!--
      Cue to show a realtime status report from the commander of a fleet.
    -->
    <cue name="RealtimeFleetStatusReport" namespace="this">
      <conditions>
        <!-- We support status reports when enemies are found and engaged -->
        <event_object_signalled object="player.primaryship" param="'UFO_FleetReport'" />
      </conditions>
      <actions>
        <!-- Fetch the fleet we want to create a report for -->
        <set_value name="$Fleet" exact="event.param2" />

        <debug_text text="'Generating status report for fleet (id = %1, name = %2, commander = %3, nr. of ships = %4, command data: %5)...'.[$Fleet.$iId, $Fleet.$sName, $Fleet.$oCommander.knownname, $Fleet.$gShips.count, $Fleet.$lCommand]" filter="error" chance="100 * (global.$UFO.$iDebugLevel ge 1)" />

        <set_value name="$iFollowCount" exact="0" />
        <set_value name="$iCapFollowCount" exact="0" />
        <do_all exact="$Fleet.$gShips.count" counter="$i">
          <set_value name="$iFollowCount" operation="add" exact="[class.ship_l,class.ship_xl].indexof.{$Fleet.$gShips.{$i}.class} == 0" />
          <set_value name="$iCapFollowCount" operation="add" exact="[class.ship_l,class.ship_xl].indexof.{$Fleet.$gShips.{$i}.class} gt 0" />
        </do_all>

        <!-- Find all enemies and their ship sizes -->
        <set_value name="$iEnemyCount" exact="0" />
        <set_value name="$iCapEnemyCount" exact="0" />
        <do_all exact="$Fleet.$lReports.count" counter="$i">
          <set_value name="$oEnemy" exact="$Fleet.$lReports.{$i}.{1}" />
          <set_value name="$iEnemyCount" operation="add" exact="[class.ship_l,class.ship_xl,class.station].indexof.{$oEnemy.class} == 0" />
          <set_value name="$iCapEnemyCount" operation="add" exact="[class.ship_l,class.ship_xl,class.station].indexof.{$oEnemy.class} gt 0" />
        </do_all>
        
        <debug_text text="'Fleet has %1 reported enemy sightings.'.[$Fleet.$lReports.count]" filter="error" chance="100 * (global.$UFO.$iDebugLevel ge 3)" />

        <!-- We construct the message -->

        <!-- Commander info -->
        <set_value name="$aFleetSection" exact="[null,{99998,1007},$Fleet.$sName,null,null,null]" />

        <!-- Fleet info -->
        <set_value name="$aFleetSection" exact="[null,{99998,26}.[$iFollowCount + $iCapFollowCount],{99998,27}.[$iCapFollowCount],null,null,{99998,28}.[$iFollowCount]]" />

        <!-- Enemy info -->
        <set_value name="$aEnemySection" exact="[null,{99998,29}.[$iEnemyCount + $iCapEnemyCount],{99998,27}.[$iCapEnemyCount],null,null,{99998,28}.[$iEnemyCount]]" />

        <!-- Action info -->
        <set_value name="$aActionSection" exact="[null,{99998,30}.[$Fleet.$oCommander.zone.knownname],{99998,31}]" />

        <show_notification timeout="12s" caption="{99998,25}" queued="true" details="[$aFleetSection,$aFleetSection,$aEnemySection,$aActionSection]" />

        <reset_cue cue="this" />
      </actions>
    </cue>

    <!-- 
      This cue catches cases where the playership is attacked and sets the 
      flag on the play fleet to indicate the attack.
      TODO: Even if we have a fleet, the flag is not guaranteed to be reset.
      Reset after some time?
    -->
    <cue name="PlayerAttackedSignaller" instantiate="true" namespace="this">
      <conditions>
        <event_object_attacked object="player.primaryship" />
        <!-- If there are no ships in the player fleet, then we don't need to signal -->
        <check_value value="@player.copilot.$UFO.$Fleet.$gShips.count gt 1" />
        <!-- We only need to set the flag, if it's not already set -->
        <check_value value="not @player.copilot.$UFO.$Fleet.$bWasAttacked" />
      </conditions>
      <actions>
        <debug_text filter="error" text="'%1 - The player was attacked. Signalling the player fleet to defend itself...'.[player.age]" chance="100 * (global.$UFO.$iDebugLevel ge 1)" />
        <set_value name="player.copilot.$UFO.$Fleet.$bWasAttacked" exact="true" />
      </actions>
    </cue>
  </cues>
</mdscript>