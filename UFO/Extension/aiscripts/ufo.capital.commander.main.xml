<?xml version="1.0" encoding="iso-8859-1" ?>
<!-- 
	This file is part of the X Rebirth UFO mod.
	
	Author: MadJoker
  
  Last Change:
	Version: V0.5.0 Beta
	Date: 26th Apr 2014
  
  X Rebirth version: 1.30
-->

<!--
  This script should only be run on entities of type commander that 
  are currently piloting a ship of size l or larger.
  
  The main script for fleet commanders piloting capital ships in UFO fleets.
-->
<aiscript name="ufo.capital.commander.main" version="1" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../../../Resources/aiscripts.xsd">
  <init>
    <do_if value="this.$UFO.$Fleet.$lCommand.{1} == global.$UFO.$Commands.$sMoveToZone">
      <set_command command="command.move" param="this.$UFO.$Fleet.$lCommand.{2}.{1}" />
    </do_if>
    <do_if value="this.$UFO.$Fleet.$lCommand.{1} == global.$UFO.$Commands.$sEscort">
      <set_command command="command.escort" param="this.$UFO.$Fleet.$lCommand.{2}.{1}" />
    </do_if>
  </init>
  <attention min="unknown">
    <actions>
      <label name="start" />
      
      <run_script name="'mj.lib.log'" sinceversion="1">
        <param name="iDebugLevel" value="global.$UFO.$iDebugLevel" />
        <save_retval name="sLogFormat" variable="$sLogFormat" />
        <save_retval name="iLogError" variable="$iLogError" />
        <save_retval name="iLogInfo" variable="$iLogInfo" />
        <save_retval name="iLogFine" variable="$iLogFine" />
        <save_retval name="iLogFinest" variable="$iLogFinest" />
      </run_script>

      <!-- First, we do some parameter sanity checking -->
      <do_if value="this.type != entitytype.commander or not [class.ship_l,class.ship_xl].indexof.{this.ship.class}">
        <debug_text filter="error" text="$sLogFormat.[player.age,'This script should only be run on entities of type commander that are currently piloting a ship of size l or larger']" />
        <return />
      </do_if>
      <do_if value="not this.$UFO? or not @this.$UFO.$Fleet">
        <debug_text filter="error" text="$sLogFormat.[player.age,'This script should only be run on entities with a valid UFO state container and that are part of a fleet.']" />
        <return />
      </do_if>
      <do_if value="this.ship != this.$UFO.$Fleet.$oCommander">
        <debug_text filter="error" text="$sLogFormat.[player.age,'This script should only be run on the commander of a fleet.']" />
        <return />
      </do_if>

      <!-- Set all state variables -->
      <set_value name="$Fleet" exact="this.$UFO.$Fleet" />
      <set_value name="$sCommand" exact="$Fleet.$lCommand.{1}" />
      <set_value name="$aCommandArgs" exact="$Fleet.$lCommand.{2}" />

      <debug_text text="$sLogFormat.[player.age,'Started fleet commander script. Fleet ID: %1, command: \'%2\', command args: %3'.[$Fleet.$iId,$sCommand,$aCommandArgs]]" filter="error" chance="$iLogInfo" />

      <!-- Now, we check for the different commands -->
      <do_if value="$sCommand == global.$UFO.$Commands.$sEscort">
        <!-- Start default follow script for captain and tell it to escort the target ship -->
        <run_script name="'ufo.capital.captain.main'" sinceversion="1">
          <param name="oEscortTarget" value="$aCommandArgs.{1}" />
        </run_script>
      </do_if>
      <do_elseif value="$sCommand == global.$UFO.$Commands.$sMoveToZone">
        <!-- Start default follow script for captain and tell it to move to the beacon -->
        <run_script name="'ufo.capital.commander.move.to.zone'" sinceversion="1"/>
      </do_elseif>
    </actions>
  </attention>
  <on_abort>
    <debug_text text="$sLogFormat.[player.age,'Aborted script. Cleaning up state...']" filter="error" chance="$iLogInfo" />
  </on_abort>
</aiscript>